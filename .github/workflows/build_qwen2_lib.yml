name: Build Qwen2.5-Coder Lib (Docker Fix)

on:
  workflow_dispatch:

jobs:
  build_lib:
    runs-on: ubuntu-latest
    container:
      image: mlcai/mlc-llm-build:latest
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Prepare Model Config
        run: |
          # Clone just the config (lightweight)
          git clone https://huggingface.co/mlc-ai/Qwen2.5-Coder-7B-Instruct-q4f16_1-MLC model_config

      - name: Compile Model Objects
        run: |
          # The container has mlc_llm installed globally
          # We use --device android to target Vulkan/OpenCL
          mlc_llm compile ./model_config \
            --quantization q4f16_1 \
            --device android \
            --system-lib-prefix qwen2 \
            --output qwen2_android.tar

      - name: Link Shared Library
        run: |
          # The container also has the NDK installed
          mkdir build_libs
          tar -xf qwen2_android.tar -C build_libs
          
          # Locate Compiler in Docker env
          # Usually at /android-ndk or similar
          # We search for it to be safe
          CLANG=$(find / -name "aarch64-linux-android*-clang" 2>/dev/null | head -n 1)
          
          if [ -z "$CLANG" ]; then
             echo "Clang not found, falling back to apt install"
             apt-get update && apt-get install -y clang
             CLANG="clang --target=aarch64-linux-android24"
          fi
          
          echo "Using Compiler: $CLANG"
          
          cd build_libs
          $CLANG -shared -fPIC -o libqwen2.so *.o

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: libqwen2.so
          path: build_libs/libqwen2.so
