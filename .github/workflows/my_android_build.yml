name: Build Reference MLCChat APK (Robust)

on:
  workflow_dispatch:

jobs:
  build_apk:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 1. Maximize Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/share/swift
          docker rmi $(docker images -q) 2>/dev/null || true

      - name: 2. Checkout MLC Source Code
        uses: actions/checkout@v4
        with:
          repository: mlc-ai/mlc-llm
          path: mlc-llm-source
          submodules: recursive

      - name: 3. Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 4. Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r27b

      - name: 5. Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 6. Install MLC Tools
        run: |
          pip install --no-cache-dir --pre -U -f https://mlc.ai/wheels mlc-llm-nightly-cpu mlc-ai-nightly-cpu

      - name: 7. Configure for Qwen 2.5
        run: |
          echo '{
            "device": "android",
            "model_list": [
              {
                "model": "HF://mlc-ai/Qwen2.5-Coder-3B-Instruct-q4f16_1-MLC",
                "model_id": "qwen2_5_coder_3b",
                "estimated_vram_bytes": 3500000000,
                "bundle_weights": false
              }
            ]
          }' > mlc-package-config.json

      - name: 8. Generate Project Files
        env:
          MLC_LLM_SOURCE_DIR: ${{ github.workspace }}/mlc-llm-source
        run: |
          export TVM_NDK_CC=$(find "$ANDROID_NDK_HOME" -name "aarch64-linux-android*-clang" | grep "bin/" | sort | head -n 1)
          NDK_BIN=$(dirname "$TVM_NDK_CC")
          LLVM_AR="$NDK_BIN/llvm-ar"
          if [ -f "$LLVM_AR" ]; then sudo ln -sf "$LLVM_AR" /usr/local/bin/llvm-ar; fi
          
          python -m mlc_llm package
          
          echo "Generated dist folder:"
          ls -R dist/ || echo "dist missing"

      - name: 9. Prepare MLCChat Project
        run: |
          # Move dist folder to where the Android project expects it
          echo "Moving dist folder into MLCChat..."
          mv dist mlc-llm-source/android/MLCChat/
          
          cd mlc-llm-source/android/MLCChat
          
          # Patch settings.gradle to remove the missing example module
          if [ -f settings.gradle ]; then
              sed -i "/mlcengineexample/d" settings.gradle
          fi
          
          # Inject AndroidX flags
          echo "android.useAndroidX=true" > gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties

      - name: 10. Build APK (Force Gradle 8.6)
        working-directory: ./mlc-llm-source/android/MLCChat
        run: |
          # System Gradle is 9.2 (Too new), so we manually install 8.6
          echo "Downloading Gradle 8.6..."
          wget -q https://services.gradle.org/distributions/gradle-8.6-bin.zip
          unzip -q gradle-8.6-bin.zip
          
          # Set up environment
          export PATH=$PWD/gradle-8.6/bin:$PATH
          
          echo "Verifying Gradle Version:"
          gradle -v
          
          echo "Building Debug APK..."
          # Run without daemon to save memory
          gradle assembleDebug --no-daemon --stacktrace

      - name: 11. Publish APK
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ref-app-robust-v${{ github.run_number }}
          name: Reference App (Robust) ${{ github.run_number }}
          files: mlc-llm-source/android/MLCChat/app/build/outputs/apk/debug/app-debug.apk
          draft: false
          prerelease: false
