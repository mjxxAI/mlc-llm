name: Build Reference MLCChat APK (Clean)

on:
  workflow_dispatch:

jobs:
  build_apk:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 1. Maximize Disk Space
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/share/swift
          docker rmi $(docker images -q) 2>/dev/null || true

      - name: 2. Checkout MLC Source Code
        uses: actions/checkout@v4
        with:
          repository: mlc-ai/mlc-llm
          path: mlc-llm-source
          submodules: recursive

      - name: 3. Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 4. Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r27b

      - name: 5. Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 6. Install MLC Tools
        run: |
          pip install --no-cache-dir --pre -U -f https://mlc.ai/wheels mlc-llm-nightly-cpu mlc-ai-nightly-cpu

      - name: 7. Configure for Qwen 2.5
        # We must provide this config so the build knows what to include.
        # This is standard usage, not a hack.
        run: |
          echo '{
            "device": "android",
            "model_list": [
              {
                "model": "HF://mlc-ai/Qwen2.5-Coder-3B-Instruct-q4f16_1-MLC",
                "model_id": "qwen2_5_coder_3b",
                "estimated_vram_bytes": 3500000000,
                "bundle_weights": false
              }
            ]
          }' > mlc-package-config.json

      - name: 8. Generate Project Files (Standard)
        env:
          MLC_LLM_SOURCE_DIR: ${{ github.workspace }}/mlc-llm-source
        run: |
          # Set NDK compiler path for TVM
          export TVM_NDK_CC=$(find "$ANDROID_NDK_HOME" -name "aarch64-linux-android*-clang" | grep "bin/" | sort | head -n 1)
          NDK_BIN=$(dirname "$TVM_NDK_CC")
          LLVM_AR="$NDK_BIN/llvm-ar"
          if [ -f "$LLVM_AR" ]; then sudo ln -sf "$LLVM_AR" /usr/local/bin/llvm-ar; fi
          
          # Standard packaging command
          python -m mlc_llm package

      - name: 9. Prepare MLCChat Project
        run: |
          # Copy the generated config assets to the Android App source
          cp dist/assets/app-config.json mlc-llm-source/android/MLCChat/src/main/assets/
          
          cd mlc-llm-source/android/MLCChat
          
          # We ONLY inject the AndroidX flag because the repo is old and needs this to compile with modern SDKs.
          # This is a Gradle requirement, not a source code hack.
          echo "android.useAndroidX=true" > gradle.properties
          echo "android.enableJetifier=true" >> gradle.properties

      - name: 10. Build APK
        working-directory: ./mlc-llm-source/android/MLCChat
        run: |
          echo "Generating Wrapper..."
          gradle wrapper --gradle-version 8.5
          chmod +x gradlew
          
          echo "Building Debug APK..."
          ./gradlew assembleDebug --stacktrace

      - name: 11. Publish APK
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ref-app-clean-v${{ github.run_number }}
          name: Reference App (Clean) ${{ github.run_number }}
          files: mlc-llm-source/android/MLCChat/app/build/outputs/apk/debug/app-debug.apk
          draft: false
          prerelease: false
